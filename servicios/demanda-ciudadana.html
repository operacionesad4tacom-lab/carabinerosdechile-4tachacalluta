<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOF - Demanda Ciudadana</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/tablet.css">
    <link rel="stylesheet" href="../css/desktop.css">
    <link rel="icon" href="../assets/logos/favicon.ico">
    <style>
        .paso-indicador {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            position: relative;
        }
        
        .paso-indicador::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--verde-claro);
            z-index: 1;
        }
        
        .paso {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .paso-numero {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--verde-claro);
            color: var(--gris-medio);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            margin-bottom: var(--spacing-sm);
            border: 4px solid var(--blanco);
            transition: all 0.3s ease;
        }
        
        .paso.activo .paso-numero {
            background-color: var(--verde-oficial);
            color: var(--blanco);
            transform: scale(1.1);
        }
        
        .paso.completado .paso-numero {
            background-color: var(--verde-exito);
            color: var(--blanco);
        }
        
        .paso-texto {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gris-medio);
            text-align: center;
            max-width: 100px;
        }
        
        .paso.activo .paso-texto {
            color: var(--verde-oficial);
        }
        
        .form-section {
            background: var(--blanco);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--verde-claro);
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            color: var(--verde-oscuro);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--verde-claro);
        }
        
        .section-icon {
            font-size: 1.5rem;
        }
        
        .counter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .counter-group {
            background: var(--gris-claro);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--verde-claro);
            transition: all 0.3s ease;
        }
        
        .counter-group:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .counter-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gris-profesional);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .counter-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--gris-medio);
            border-radius: var(--border-radius-sm);
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            font-family: var(--font-primary);
            background: var(--blanco);
            transition: all 0.3s ease;
        }
        
        .counter-input:focus {
            outline: none;
            border-color: var(--verde-oficial);
            box-shadow: 0 0 0 3px rgba(11, 107, 58, 0.1);
        }
        
        .counter-help {
            font-size: 0.75rem;
            color: var(--gris-medio);
            margin-top: var(--spacing-xs);
        }
        
        .counter-total {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--verde-oficial);
            margin-top: var(--spacing-sm);
            text-align: center;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(11, 107, 58, 0.1);
            border-radius: var(--border-radius-sm);
        }
        
        .grid-2, .grid-3 {
            display: grid;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .resumen-box {
            background: var(--gris-muy-claro);
            border: 2px solid var(--verde-claro);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            display: none;
        }
        
        .resumen-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--verde-oscuro);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .resumen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .resumen-item {
            text-align: center;
            padding: var(--spacing-sm);
            background: var(--blanco);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--gris-claro);
        }
        
        .resumen-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--verde-oficial);
        }
        
        .resumen-label {
            font-size: 0.75rem;
            color: var(--gris-medio);
            margin-top: 4px;
        }
        
        .error-message {
            color: var(--rojo-alerta);
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }
        
        .has-error .counter-input {
            border-color: var(--rojo-alerta);
        }
        
        .has-error .counter-help {
            color: var(--rojo-alerta);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading-message {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .loading-details {
            font-size: 0.875rem;
            color: var(--gris-medio);
        }
        
        .step-status {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            min-height: 20px;
        }
        
        .step-success {
            color: var(--verde-exito);
        }
        
        .step-error {
            color: var(--rojo-alerta);
        }
        
        .step-processing {
            color: var(--azul-info);
        }
        
        .alert-detencion {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #ff9800;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            display: none;
        }
        
        .alert-detencion-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .alert-detencion-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #e65100;
            margin-bottom: var(--spacing-xs);
        }
        
        .alert-detencion-message {
            color: #5d4037;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Header Institucional -->
    <header class="header-institucional">
        <div class="header-content">
            <div class="logo-container">
                <img src="../assets/logos/escudo-carabineros.png" alt="Carabineros de Chile" class="logo-img">
                <div class="logo-text">
                    <div class="logo-title">SICOF - Sistema Integrado</div>
                    <div class="logo-subtitle">Demanda Ciudadana - Paso 2</div>
                </div>
            </div>
            <div class="user-info" style="color: var(--blanco); text-align: right;">
                <div id="cuartelNombre" style="font-weight: 600;">Cargando...</div>
                <div style="font-size: 0.875rem; opacity: 0.9;" id="userInfo">Digitador</div>
            </div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-icon">‚è≥</div>
            <div class="loading-message" id="loadingMessage">Actualizando datos...</div>
            <div class="loading-details" id="loadingDetails"></div>
            <div class="step-status" id="step1Status"></div>
            <div class="step-status" id="step2Status"></div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main class="container" style="padding: var(--spacing-xl) 0;">
        <!-- Indicador de Pasos -->
        <div class="paso-indicador">
            <div class="paso completado">
                <div class="paso-numero">‚úì</div>
                <div class="paso-texto">Datos del Servicio</div>
            </div>
            <div class="paso activo">
                <div class="paso-numero">2</div>
                <div class="paso-texto">Demanda Ciudadana</div>
            </div>
            <div class="paso">
                <div class="paso-numero">3</div>
                <div class="paso-texto">Demanda Preventiva</div>
            </div>
            <div class="paso">
                <div class="paso-numero">4</div>
                <div class="paso-texto">Confirmaci√≥n</div>
            </div>
        </div>
        
        <!-- Mensajes -->
        <div id="message" class="alert" style="display: none;"></div>
        
        <!-- Informaci√≥n del Servicio -->
        <div class="form-section">
            <h3 class="section-title">
                <span class="section-icon">üìã</span>
                INFORMACI√ìN DEL SERVICIO
            </h3>
            
            <div class="grid-3">
                <div class="form-group">
                    <div class="form-label">üìÖ FECHA</div>
                    <div class="form-control-static" id="infoFecha">Cargando...</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">üè¢ CUARTEL</div>
                    <div class="form-control-static" id="infoCuartel">Cargando...</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">üëÆ‚Äç‚ôÇÔ∏è JEFE</div>
                    <div class="form-control-static" id="infoJefe">Cargando...</div>
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-label">üöî SERVICIO</div>
                <div class="form-control-static" id="infoServicio">Cargando...</div>
            </div>
        </div>
        
        <!-- Formulario -->
        <form id="demandaForm">
            <!-- Controles Realizados -->
            <div class="form-section">
                <h3 class="section-title">
                    <span class="section-icon">üîç</span>
                    CONTROLES REALIZADOS
                </h3>
                
                <div class="counter-grid">
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üîé</span>
                            CONTROLES INVESTIGATIVOS
                        </div>
                        <input 
                            type="number" 
                            id="controles_investigativos"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Controles con fines investigativos
                        </div>
                        <div class="error-message" id="controlesInvestigativosError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üõ°Ô∏è</span>
                            CONTROLES PREVENTIVOS
                        </div>
                        <input 
                            type="number" 
                            id="controles_preventivos"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Controles de prevenci√≥n y disuasi√≥n
                        </div>
                        <div class="error-message" id="controlesPreventivosError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üåé</span>
                            CONTROLES MIGRATORIOS
                        </div>
                        <input 
                            type="number" 
                            id="controles_migratorios"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Verificaci√≥n de documentaci√≥n migratoria
                        </div>
                        <div class="error-message" id="controlesMigratoriosError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üöó</span>
                            CONTROLES VEHICULARES
                        </div>
                        <input 
                            type="number" 
                            id="controles_vehiculares"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Inspecci√≥n de veh√≠culos y carga
                        </div>
                        <div class="error-message" id="controlesVehicularesError"></div>
                    </div>
                </div>
                
                <div class="counter-total" id="totalControles">
                    TOTAL CONTROLES: 0
                </div>
            </div>
            
            <!-- Infracciones Detectadas -->
            <div class="form-section">
                <h3 class="section-title">
                    <span class="section-icon">‚öñÔ∏è</span>
                    INFRACCIONES DETECTADAS
                </h3>
                
                <div class="counter-grid">
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üö¶</span>
                            INFRACCIONES DE TR√ÅNSITO
                        </div>
                        <input 
                            type="number" 
                            id="infracciones_transito"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Infracciones a la ley de tr√°nsito
                        </div>
                        <div class="error-message" id="infraccionesTransitoError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üìã</span>
                            OTRAS INFRACCIONES
                        </div>
                        <input 
                            type="number" 
                            id="otras_infracciones"
                            class="counter-input"
                            min="0"
                            max="9999"
                            value="0"
                        >
                        <div class="counter-help">
                            Infracciones a otras normativas
                        </div>
                        <div class="error-message" id="otrasInfraccionesError"></div>
                    </div>
                </div>
                
                <div class="counter-total" id="totalInfracciones">
                    TOTAL INFRACCIONES: 0
                </div>
            </div>
            
            <!-- Personas Detenidas -->
            <div class="form-section">
                <h3 class="section-title">
                    <span class="section-icon">üö®</span>
                    PERSONAS DETENIDAS
                </h3>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="detenidos_cantidad" class="form-label">
                            üë§ CANTIDAD DE DETENIDOS
                        </label>
                        <input 
                            type="number" 
                            id="detenidos_cantidad"
                            class="form-control"
                            min="0"
                            max="999"
                            value="0"
                        >
                        <div class="counter-help">
                            N√∫mero total de personas detenidas
                        </div>
                        <div class="error-message" id="detenidosCantidadError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="motivo_detencion" class="form-label">
                            üìù MOTIVO DE DETENCI√ìN
                        </label>
                        <select id="motivo_detencion" class="form-control">
                            <option value="">Sin detenidos</option>
                            <option value="robo_hurto">Robo/Hurto</option>
                            <option value="drogas">Drogas</option>
                            <option value="contrabando">Contrabando</option>
                            <option value="ley_control_armas">Ley Control de Armas</option>
                            <option value="trafico_migrantes">Tr√°fico de Migrantes</option>
                            <option value="receptacion_vehiculos">Receptaci√≥n de Veh√≠culos</option>
                            <option value="otros">Otros</option>
                        </select>
                        <div class="counter-help">
                            Motivo principal de la detenci√≥n
                        </div>
                        <div class="error-message" id="motivoDetencionError"></div>
                    </div>
                </div>
                
                <!-- Alerta si hay detenidos -->
                <div class="alert-detencion" id="alertaDetencion">
                    <div class="alert-detencion-icon">üö®</div>
                    <div class="alert-detencion-title">ATENCI√ìN: PERSONAS DETENIDAS</div>
                    <div class="alert-detencion-message">
                        Se han registrado detenciones durante el servicio. Esta informaci√≥n ser√° reportada a la jefatura.
                    </div>
                </div>
            </div>
            
            <!-- Denuncias por Vulneraci√≥n -->
            <div class="form-section">
                <h3 class="section-title">
                    <span class="section-icon">üõ°Ô∏è</span>
                    DENUNCIAS POR VULNERACI√ìN DE DERECHOS
                </h3>
                
                <div class="grid-3">
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üìã</span>
                            CANTIDAD DE DENUNCIAS
                        </div>
                        <input 
                            type="number" 
                            id="denuncias_vulneracion"
                            class="counter-input"
                            min="0"
                            max="999"
                            value="0"
                        >
                        <div class="counter-help">
                            Denuncias recibidas
                        </div>
                        <div class="error-message" id="denunciasVulneracionError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üë∂</span>
                            PARTICIPANTES NNA
                        </div>
                        <input 
                            type="number" 
                            id="participantes_nna"
                            class="counter-input"
                            min="0"
                            max="999"
                            value="0"
                        >
                        <div class="counter-help">
                            Ni√±os, Ni√±as, Adolescentes
                        </div>
                        <div class="error-message" id="participantesNnaError"></div>
                    </div>
                    
                    <div class="counter-group">
                        <div class="counter-title">
                            <span>üë®</span>
                            PARTICIPANTES ADULTOS
                        </div>
                        <input 
                            type="number" 
                            id="participantes_adultos"
                            class="counter-input"
                            min="0"
                            max="999"
                            value="0"
                        >
                        <div class="counter-help">
                            Adultos participantes
                        </div>
                        <div class="error-message" id="participantesAdultosError"></div>
                    </div>
                </div>
            </div>
            
            <!-- Resumen de Datos -->
            <div class="resumen-box" id="resumenDatos">
                <div class="resumen-title">
                    <span>üìä</span>
                    RESUMEN DE DEMANDA CIUDADANA
                </div>
                <div class="resumen-grid">
                    <div class="resumen-item">
                        <div class="resumen-valor" id="resumenTotalControles">0</div>
                        <div class="resumen-label">CONTROLES</div>
                    </div>
                    <div class="resumen-item">
                        <div class="resumen-valor" id="resumenTotalInfracciones">0</div>
                        <div class="resumen-label">INFRACCIONES</div>
                    </div>
                    <div class="resumen-item">
                        <div class="resumen-valor" id="resumenTotalDetenidos">0</div>
                        <div class="resumen-label">DETENIDOS</div>
                    </div>
                    <div class="resumen-item">
                        <div class="resumen-valor" id="resumenTotalDenuncias">0</div>
                        <div class="resumen-label">DENUNCIAS</div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de Navegaci√≥n -->
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-outline" onclick="window.location.href='datos-servicio.html'">
                    ‚Üê VOLVER AL PASO 1
                </button>
                
                <div style="display: flex; gap: var(--spacing-md);">
                    <button type="button" class="btn btn-outline" onclick="window.location.href='../index.html'">
                        üö™ Salir
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnContinuar">
                        GUARDAR Y CONTINUAR ‚Üí
                    </button>
                </div>
            </div>
        </form>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script>
        // Variables globales
        let userData = {};
        let servicioId = null;
        let servicioInfo = {};
        let modoOffline = false;
        
        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(texto, tipo = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = texto;
            messageEl.className = `alert alert-${tipo}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // Funci√≥n para mostrar error en campo
        function mostrarErrorCampo(campoId, mensaje) {
            const campo = document.getElementById(campoId);
            const errorEl = document.getElementById(campoId + 'Error');
            
            if (errorEl) {
                errorEl.textContent = mensaje;
                campo.parentElement.classList.add('has-error');
            }
        }
        
        // Funci√≥n para limpiar errores
        function limpiarErrores() {
            document.querySelectorAll('.has-error').forEach(el => {
                el.classList.remove('has-error');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }
        
        // Funci√≥n para actualizar loading
        function actualizarLoading(mensaje, detalles = '', paso = 1, estado = 'processing') {
            document.getElementById('loadingMessage').textContent = mensaje;
            document.getElementById('loadingDetails').textContent = detalles;
            
            const stepEl = document.getElementById(`step${paso}Status`);
            if (stepEl) {
                stepEl.textContent = detalles;
                stepEl.className = `step-status step-${estado}`;
            }
        }
        
        // Funci√≥n para calcular totales
        function calcularTotales() {
            // Calcular total controles
            const controlesInvestigativos = parseInt(document.getElementById('controles_investigativos').value) || 0;
            const controlesPreventivos = parseInt(document.getElementById('controles_preventivos').value) || 0;
            const controlesMigratorios = parseInt(document.getElementById('controles_migratorios').value) || 0;
            const controlesVehiculares = parseInt(document.getElementById('controles_vehiculares').value) || 0;
            
            const totalControles = controlesInvestigativos + controlesPreventivos + controlesMigratorios + controlesVehiculares;
            document.getElementById('totalControles').textContent = `TOTAL CONTROLES: ${totalControles}`;
            document.getElementById('resumenTotalControles').textContent = totalControles;
            
            // Calcular total infracciones
            const infraccionesTransito = parseInt(document.getElementById('infracciones_transito').value) || 0;
            const otrasInfracciones = parseInt(document.getElementById('otras_infracciones').value) || 0;
            
            const totalInfracciones = infraccionesTransito + otrasInfracciones;
            document.getElementById('totalInfracciones').textContent = `TOTAL INFRACCIONES: ${totalInfracciones}`;
            document.getElementById('resumenTotalInfracciones').textContent = totalInfracciones;
            
            // Actualizar detenidos
            const detenidosCantidad = parseInt(document.getElementById('detenidos_cantidad').value) || 0;
            document.getElementById('resumenTotalDetenidos').textContent = detenidosCantidad;
            
            // Mostrar/ocultar alerta de detenidos
            const alertaDetencion = document.getElementById('alertaDetencion');
            if (detenidosCantidad > 0) {
                alertaDetencion.style.display = 'block';
            } else {
                alertaDetencion.style.display = 'none';
            }
            
            // Calcular total denuncias
            const denunciasVulneracion = parseInt(document.getElementById('denuncias_vulneracion').value) || 0;
            const participantesNna = parseInt(document.getElementById('participantes_nna').value) || 0;
            const participantesAdultos = parseInt(document.getElementById('participantes_adultos').value) || 0;
            
            const totalDenuncias = denunciasVulneracion + participantesNna + participantesAdultos;
            document.getElementById('resumenTotalDenuncias').textContent = totalDenuncias;
            
            // Mostrar resumen si hay datos
            const resumenDatos = document.getElementById('resumenDatos');
            if (totalControles > 0 || totalInfracciones > 0 || detenidosCantidad > 0 || totalDenuncias > 0) {
                resumenDatos.style.display = 'block';
            } else {
                resumenDatos.style.display = 'none';
            }
        }
        
        // Funci√≥n para validar formulario
        function validarFormulario() {
            let esValido = true;
            limpiarErrores();
            
            // Validar que si hay detenidos, debe haber motivo
            const detenidosCantidad = parseInt(document.getElementById('detenidos_cantidad').value) || 0;
            const motivoDetencion = document.getElementById('motivo_detencion').value;
            
            if (detenidosCantidad > 0 && !motivoDetencion) {
                mostrarErrorCampo('motivo_detencion', 'Debe especificar el motivo de detenci√≥n');
                esValido = false;
            }
            
            // Validar n√∫meros positivos
            const camposNumericos = [
                'controles_investigativos', 'controles_preventivos', 'controles_migratorios', 'controles_vehiculares',
                'infracciones_transito', 'otras_infracciones', 'detenidos_cantidad',
                'denuncias_vulneracion', 'participantes_nna', 'participantes_adultos'
            ];
            
            camposNumericos.forEach(campoId => {
                const valor = parseInt(document.getElementById(campoId).value) || 0;
                if (valor < 0) {
                    mostrarErrorCampo(campoId, 'El valor no puede ser negativo');
                    esValido = false;
                }
            });
            
            return esValido;
        }
        
        // Funci√≥n para cargar informaci√≥n del servicio
        async function cargarInformacionServicio() {
            try {
                // Obtener datos del paso 1 desde localStorage
                const paso1Data = localStorage.getItem('servicio_paso1');
                if (!paso1Data) {
                    throw new Error('No se encontraron datos del paso 1');
                }
                
                servicioInfo = JSON.parse(paso1Data);
                servicioId = localStorage.getItem('servicio_id');
                
                if (!servicioId) {
                    throw new Error('No se encontr√≥ ID del servicio');
                }
                
                console.log('üìã Informaci√≥n del servicio cargada:', servicioInfo);
                
                // Mostrar informaci√≥n en la p√°gina
                document.getElementById('infoFecha').textContent = servicioInfo.fecha;
                document.getElementById('infoCuartel').textContent = servicioInfo.cuartel_codigo;
                document.getElementById('infoJefe').textContent = servicioInfo.jefe_servicio;
                document.getElementById('infoServicio').textContent = servicioInfo.nombre_servicio;
                
                // Verificar si el servicio existe en Supabase
                actualizarLoading('Verificando servicio...', 'Buscando en base de datos', 1, 'processing');
                
                const { data: servicioExistente, error } = await SICOF_CONFIG.supabase
                    .from('servicios')
                    .select('id, cuartel_codigo, nombre_servicio')
                    .eq('id', servicioId)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') { // No encontrado
                        console.warn('‚ö†Ô∏è Servicio no encontrado en Supabase, usando modo offline');
                        modoOffline = true;
                        mostrarMensaje('‚ö†Ô∏è Modo offline: Los datos se guardar√°n localmente', 'warning');
                    } else {
                        throw error;
                    }
                } else {
                    console.log('‚úÖ Servicio verificado en Supabase:', servicioExistente);
                    actualizarLoading('Servicio verificado', 'Listo para continuar', 1, 'success');
                }
                
                // Cargar datos guardados del paso 2 si existen
                const paso2Data = localStorage.getItem('servicio_paso2');
                if (paso2Data) {
                    const datosPaso2 = JSON.parse(paso2Data);
                    console.log('üìÇ Datos del paso 2 cargados:', datosPaso2);
                    
                    // Llenar campos con datos existentes
                    Object.keys(datosPaso2).forEach(key => {
                        const elemento = document.getElementById(key);
                        if (elemento) {
                            if (elemento.type === 'number') {
                                elemento.value = datosPaso2[key] || 0;
                            } else if (elemento.tagName === 'SELECT') {
                                elemento.value = datosPaso2[key] || '';
                            }
                        }
                    });
                    
                    // Calcular totales iniciales
                    calcularTotales();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando informaci√≥n del servicio:', error);
                throw error;
            }
        }
        
        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando demanda-ciudadana.html');
            
            try {
                // Verificar autenticaci√≥n
                userData = await protegerPagina('digitador');
                if (!userData) return;
                
                console.log('‚úÖ Usuario autenticado:', userData);
                
                // Mostrar informaci√≥n del usuario
                document.getElementById('userInfo').textContent = `${userData.rol.toUpperCase()} - ${userData.email}`;
                
                // Mostrar cuartel
                const cuartelInfo = await obtenerCuarteles();
                const cuartelUsuario = cuartelInfo.find(c => c.codigo === userData.cuartel_codigo);
                if (cuartelUsuario) {
                    document.getElementById('cuartelNombre').textContent = cuartelUsuario.nombre;
                }
                
                // Cargar informaci√≥n del servicio
                await cargarInformacionServicio();
                
                // Configurar eventos
                configurarEventos();
                
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                
                if (error.message.includes('paso 1')) {
                    mostrarMensaje('‚ùå Complete primero el paso 1: Datos del Servicio', 'danger');
                    setTimeout(() => window.location.href = 'datos-servicio.html', 2000);
                } else {
                    mostrarMensaje(`Error inicializando: ${error.message}`, 'danger');
                }
            }
        });
        
        function configurarEventos() {
            // Calcular totales en tiempo real
            const camposCalculo = [
                'controles_investigativos', 'controles_preventivos', 'controles_migratorios', 'controles_vehiculares',
                'infracciones_transito', 'otras_infracciones', 'detenidos_cantidad',
                'denuncias_vulneracion', 'participantes_nna', 'participantes_adultos'
            ];
            
            camposCalculo.forEach(id => {
                document.getElementById(id).addEventListener('input', calcularTotales);
            });
            
            // Mostrar/ocultar alerta de detenidos
            document.getElementById('detenidos_cantidad').addEventListener('input', function() {
                const detenidos = parseInt(this.value) || 0;
                const motivoSelect = document.getElementById('motivo_detencion');
                
                if (detenidos > 0) {
                    if (motivoSelect.value === '') {
                        motivoSelect.value = 'robo_hurto';
                    }
                } else {
                    motivoSelect.value = '';
                }
            });
            
            // Validar n√∫meros positivos
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    const value = parseInt(this.value);
                    if (isNaN(value) || value < 0) {
                        this.value = 0;
                    }
                    if (value > parseInt(this.max) || 9999) {
                        this.value = this.max || 9999;
                    }
                });
            });
            
            // Manejar env√≠o del formulario
            document.getElementById('demandaForm').addEventListener('submit', guardarPaso2);
        }
        
        async function guardarPaso2(e) {
            e.preventDefault();
            
            console.log('üìù Iniciando guardado del paso 2...');
            
            // Validar formulario
            if (!validarFormulario()) {
                mostrarMensaje('‚ùå Por favor corrija los errores en el formulario', 'danger');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            actualizarLoading('Guardando datos de demanda ciudadana...', 'Paso 2: Controles e infracciones', 1, 'processing');
            
            try {
                // Preparar datos para actualizar
                const formData = {
                    // Controles
                    controles_investigativos: parseInt(document.getElementById('controles_investigativos').value) || 0,
                    controles_preventivos: parseInt(document.getElementById('controles_preventivos').value) || 0,
                    controles_migratorios: parseInt(document.getElementById('controles_migratorios').value) || 0,
                    controles_vehiculares: parseInt(document.getElementById('controles_vehiculares').value) || 0,
                    
                    // Infracciones
                    infracciones_transito: parseInt(document.getElementById('infracciones_transito').value) || 0,
                    otras_infracciones: parseInt(document.getElementById('otras_infracciones').value) || 0,
                    
                    // Detenidos
                    detenidos_cantidad: parseInt(document.getElementById('detenidos_cantidad').value) || 0,
                    motivo_detencion: document.getElementById('motivo_detencion').value || null,
                    
                    // Denuncias
                    denuncias_vulneracion: parseInt(document.getElementById('denuncias_vulneracion').value) || 0,
                    participantes_nna: parseInt(document.getElementById('participantes_nna').value) || 0,
                    participantes_adultos: parseInt(document.getElementById('participantes_adultos').value) || 0
                };
                
                console.log('üì¶ Datos preparados para actualizar:', formData);
                
                // Verificar si estamos en modo offline
                if (modoOffline) {
                    console.log('üåê Modo offline detectado, guardando localmente');
                    
                    // Guardar datos en localStorage
                    localStorage.setItem('servicio_paso2', JSON.stringify(formData));
                    localStorage.setItem('servicio_offline', 'true');
                    
                    actualizarLoading('‚úÖ Datos guardados localmente', 'Modo offline activado', 2, 'success');
                    
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        mostrarMensaje(`
                            ‚úÖ <strong>DATOS GUARDADOS LOCALMENTE</strong><br>
                            ‚Ä¢ Modo offline activado<br>
                            ‚Ä¢ Los datos se sincronizar√°n cuando haya conexi√≥n<br>
                            ‚Ä¢ Redirigiendo al paso 3...
                        `, 'warning');
                        
                        // Redirigir al paso 3
                        setTimeout(() => {
                            window.location.href = 'demanda-preventiva.html';
                        }, 2000);
                    }, 1500);
                    
                    return;
                }
                
                // Actualizar en Supabase
                actualizarLoading('Actualizando en base de datos...', 'Tabla: servicios', 2, 'processing');
                
                const { data, error } = await SICOF_CONFIG.supabase
                    .from('servicios')
                    .update(formData)
                    .eq('id', servicioId);
                
                if (error) {
                    console.error('‚ùå Error actualizando en Supabase:', error);
                    
                    if (error.code === '42501') {
                        throw new Error('Permiso denegado: No tiene permisos para actualizar');
                    } else if (error.code === 'PGRST116') {
                        throw new Error('El servicio no existe en la base de datos');
                    } else {
                        throw new Error(`Error de base de datos: ${error.message}`);
                    }
                }
                
                console.log('‚úÖ Servicio actualizado exitosamente:', data);
                
                // Guardar datos en localStorage tambi√©n
                localStorage.setItem('servicio_paso2', JSON.stringify(formData));
                
                actualizarLoading('‚úÖ Paso 2 completado', 'Datos guardados correctamente', 2, 'success');
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Mostrar estad√≠sticas
                    const totalControles = 
                        formData.controles_investigativos + 
                        formData.controles_preventivos + 
                        formData.controles_migratorios + 
                        formData.controles_vehiculares;
                    
                    const totalInfracciones = formData.infracciones_transito + formData.otras_infracciones;
                    
                    mostrarMensaje(`
                        ‚úÖ <strong>PASO 2 COMPLETADO CORRECTAMENTE</strong><br>
                        ‚Ä¢ Controles realizados: ${totalControles}<br>
                        ‚Ä¢ Infracciones detectadas: ${totalInfracciones}<br>
                        ‚Ä¢ Personas detenidas: ${formData.detenidos_cantidad}<br>
                        ‚Ä¢ Redirigiendo al paso 3...
                    `, 'success');
                    
                    // Redirigir al paso 3 despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'demanda-preventiva.html';
                    }, 2000);
                    
                }, 1500);
                
            } catch (error) {
                console.error('üî• Error guardando paso 2:', error);
                
                actualizarLoading('‚ùå Error al guardar', error.message, 2, 'error');
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Intentar guardar localmente como fallback
                    try {
                        const formData = {
                            controles_investigativos: parseInt(document.getElementById('controles_investigativos').value) || 0,
                            controles_preventivos: parseInt(document.getElementById('controles_preventivos').value) || 0,
                            controles_migratorios: parseInt(document.getElementById('controles_migratorios').value) || 0,
                            controles_vehiculares: parseInt(document.getElementById('controles_vehiculares').value) || 0,
                            infracciones_transito: parseInt(document.getElementById('infracciones_transito').value) || 0,
                            otras_infracciones: parseInt(document.getElementById('otras_infracciones').value) || 0,
                            detenidos_cantidad: parseInt(document.getElementById('detenidos_cantidad').value) || 0,
                            motivo_detencion: document.getElementById('motivo_detencion').value || null,
                            denuncias_vulneracion: parseInt(document.getElementById('denuncias_vulneracion').value) || 0,
                            participantes_nna: parseInt(document.getElementById('participantes_nna').value) || 0,
                            participantes_adultos: parseInt(document.getElementById('participantes_adultos').value) || 0
                        };
                        
                        localStorage.setItem('servicio_paso2', JSON.stringify(formData));
                        localStorage.setItem('servicio_offline', 'true');
                        modoOffline = true;
                        
                        console.log('üíæ Datos guardados en modo offline');
                        
                        mostrarMensaje(`
                            ‚ö†Ô∏è <strong>MODO OFFLINE ACTIVADO</strong><br>
                            ‚Ä¢ Error de conexi√≥n a la base de datos<br>
                            ‚Ä¢ Los datos se guardaron localmente<br>
                            ‚Ä¢ Se sincronizar√°n cuando haya conexi√≥n<br>
                            ‚Ä¢ Redirigiendo al paso 3...
                        `, 'warning');
                        
                        setTimeout(() => {
                            window.location.href = 'demanda-preventiva.html';
                        }, 3000);
                        
                    } catch (localError) {
                        console.error('Error guardando localmente:', localError);
                        mostrarMensaje(`‚ùå Error cr√≠tico: ${error.message}<br>No se pudieron guardar los datos`, 'danger');
                    }
                }, 2000);
            }
        }
        
        // Funci√≥n para debugging
        window.debugInfo = function() {
            console.log('=== DEBUG DEMANDA-CIUDADANA ===');
            console.log('Usuario:', userData);
            console.log('Servicio ID:', servicioId);
            console.log('Servicio Info:', servicioInfo);
            console.log('Modo Offline:', modoOffline);
            console.log('Servicio Paso 2 (localStorage):', localStorage.getItem('servicio_paso2'));
            console.log('SICOF_CONFIG:', SICOF_CONFIG ? 'Presente' : 'Ausente');
            console.log('Supabase inicializado:', SICOF_CONFIG.supabase ? '‚úÖ' : '‚ùå');
            console.log('===============================');
            
            alert('Debug info en consola. Verifica la consola del navegador (F12)');
        };
    </script>
</body>
</html>
