<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOF - Demanda Preventiva</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/tablet.css">
    <link rel="stylesheet" href="../css/desktop.css">
    <link rel="icon" href="../assets/logos/favicon.ico">
    <style>
        .paso-indicador {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            position: relative;
        }
        
        .paso-indicador::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--verde-claro);
            z-index: 1;
        }
        
        .paso {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .paso-numero {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--verde-claro);
            color: var(--gris-medio);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            margin-bottom: var(--spacing-sm);
            border: 4px solid var(--blanco);
            transition: all 0.3s ease;
        }
        
        .paso.activo .paso-numero {
            background-color: var(--verde-oficial);
            color: var(--blanco);
            transform: scale(1.1);
        }
        
        .paso.completado .paso-numero {
            background-color: var(--verde-exito);
            color: var(--blanco);
        }
        
        .paso-texto {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gris-medio);
            text-align: center;
            max-width: 100px;
        }
        
        .paso.activo .paso-texto {
            color: var(--verde-oficial);
        }
        
        .form-section {
            background: var(--blanco);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--verde-claro);
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            color: var(--verde-oscuro);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--verde-claro);
        }
        
        .section-icon {
            font-size: 1.5rem;
        }
        
        .planificacion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-xl);
        }
        
        .planificacion-card {
            background: var(--gris-claro);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--verde-claro);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .planificacion-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .planificacion-card.completa {
            border-color: var(--verde-exito);
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(46, 204, 113, 0.1) 100%);
        }
        
        .planificacion-card.parcial {
            border-color: var(--naranja-advertencia);
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(241, 196, 15, 0.1) 100%);
        }
        
        .planificacion-card.sin-realizar {
            border-color: var(--rojo-alerta);
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%);
        }
        
        .planificacion-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .planificacion-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .planificacion-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--verde-oscuro);
            margin-bottom: var(--spacing-xs);
        }
        
        .planificacion-subtitle {
            font-size: 0.875rem;
            color: var(--gris-medio);
        }
        
        .planificacion-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            text-align: center;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .input-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gris-profesional);
            margin-bottom: var(--spacing-xs);
        }
        
        .planificacion-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--gris-medio);
            border-radius: var(--border-radius-sm);
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            font-family: var(--font-primary);
            background: var(--blanco);
            transition: all 0.3s ease;
        }
        
        .planificacion-input:focus {
            outline: none;
            border-color: var(--verde-oficial);
            box-shadow: 0 0 0 3px rgba(11, 107, 58, 0.1);
        }
        
        .planificacion-input.error {
            border-color: var(--rojo-alerta);
            background: rgba(231, 76, 60, 0.05);
        }
        
        .validacion-mensaje {
            font-size: 0.75rem;
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            text-align: center;
            display: none;
        }
        
        .validacion-correcta {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--verde-exito);
            border: 1px solid rgba(39, 174, 96, 0.2);
            display: block;
        }
        
        .validacion-incorrecta {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--rojo-alerta);
            border: 1px solid rgba(231, 76, 60, 0.2);
            display: block;
        }
        
        .validacion-advertencia {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--naranja-advertencia);
            border: 1px solid rgba(243, 156, 18, 0.2);
            display: block;
        }
        
        .validacion-info {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--azul-info);
            border: 1px solid rgba(52, 152, 219, 0.2);
            display: block;
        }
        
        .estado-cumplimiento {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: none;
        }
        
        .estado-completa {
            background-color: var(--verde-exito);
            display: block;
        }
        
        .estado-parcial {
            background-color: var(--naranja-advertencia);
            display: block;
        }
        
        .estado-sin-realizar {
            background-color: var(--rojo-alerta);
            display: block;
        }
        
        .resumen-general {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            text-align: center;
            display: none;
        }
        
        .resumen-icono {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }
        
        .resumen-titulo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }
        
        .resumen-valor {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: var(--spacing-sm);
        }
        
        .resumen-descripcion {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .error-message {
            color: var(--rojo-alerta);
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }
        
        .has-error .planificacion-input {
            border-color: var(--rojo-alerta);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading-message {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .loading-details {
            font-size: 0.875rem;
            color: var(--gris-medio);
        }
        
        .step-status {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            min-height: 20px;
        }
        
        .step-success {
            color: var(--verde-exito);
        }
        
        .step-error {
            color: var(--rojo-alerta);
        }
        
        .step-processing {
            color: var(--azul-info);
        }
        
        .observaciones-counter {
            font-size: 0.75rem;
            color: var(--gris-medio);
            text-align: right;
            margin-top: 4px;
        }
        
        .observaciones-counter.warning {
            color: var(--naranja-advertencia);
        }
        
        .observaciones-counter.error {
            color: var(--rojo-alerta);
        }
    </style>
</head>
<body>
    <!-- Header Institucional -->
    <header class="header-institucional">
        <div class="header-content">
            <div class="logo-container">
                <img src="../assets/logos/escudo-carabineros.png" alt="Carabineros de Chile" class="logo-img">
                <div class="logo-text">
                    <div class="logo-title">SICOF - Sistema Integrado</div>
                    <div class="logo-subtitle">Demanda Preventiva - Paso 3</div>
                </div>
            </div>
            <div class="user-info" style="color: var(--blanco); text-align: right;">
                <div id="cuartelNombre" style="font-weight: 600;">Cargando...</div>
                <div style="font-size: 0.875rem; opacity: 0.9;" id="userInfo">Digitador</div>
            </div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-icon">‚è≥</div>
            <div class="loading-message" id="loadingMessage">Actualizando datos...</div>
            <div class="loading-details" id="loadingDetails"></div>
            <div class="step-status" id="step1Status"></div>
            <div class="step-status" id="step2Status"></div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main class="container" style="padding: var(--spacing-xl) 0;">
        <!-- Indicador de Pasos -->
        <div class="paso-indicador">
            <div class="paso completado">
                <div class="paso-numero">‚úì</div>
                <div class="paso-texto">Datos del Servicio</div>
            </div>
            <div class="paso completado">
                <div class="paso-numero">‚úì</div>
                <div class="paso-texto">Demanda Ciudadana</div>
            </div>
            <div class="paso activo">
                <div class="paso-numero">3</div>
                <div class="paso-texto">Demanda Preventiva</div>
            </div>
            <div class="paso">
                <div class="paso-numero">4</div>
                <div class="paso-texto">Confirmaci√≥n</div>
            </div>
        </div>
        
        <!-- Mensajes -->
        <div id="message" class="alert" style="display: none;"></div>
        
        <!-- Informaci√≥n del Servicio -->
        <div class="form-section">
            <h3 class="section-title">
                <span class="section-icon">üìã</span>
                RESUMEN DE SERVICIO
            </h3>
            
            <div class="grid-3">
                <div class="form-group">
                    <div class="form-label">üìÖ FECHA</div>
                    <div class="form-control-static" id="infoFecha">Cargando...</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">üè¢ CUARTEL</div>
                    <div class="form-control-static" id="infoCuartel">Cargando...</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">üöî SERVICIO</div>
                    <div class="form-control-static" id="infoServicio">Cargando...</div>
                </div>
            </div>
            
            <div class="grid-3">
                <div class="form-group">
                    <div class="form-label">üîç CONTROLES</div>
                    <div class="form-control-static" id="infoControles">0</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">‚öñÔ∏è INFRACCIONES</div>
                    <div class="form-control-static" id="infoInfracciones">0</div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">üö® DETENIDOS</div>
                    <div class="form-control-static" id="infoDetenidos">0</div>
                </div>
            </div>
        </div>
        
        <!-- Formulario -->
        <form id="preventivaForm">
            <!-- Planificaci√≥n Carta de Situaci√≥n -->
            <div class="form-section">
                <h3 class="section-title">
                    <span class="section-icon">üó∫Ô∏è</span>
                    PLANIFICACI√ìN CARTA DE SITUACI√ìN
                </h3>
                
                <div class="planificacion-grid">
                    <!-- HITOS -->
                    <div class="planificacion-card" id="cardHitos">
                        <div class="estado-cumplimiento" id="estadoHitos"></div>
                        
                        <div class="planificacion-header">
                            <div class="planificacion-icon">üìç</div>
                            <div class="planificacion-title">HITOS FRONTERIZOS</div>
                            <div class="planificacion-subtitle">Marcadores territoriales</div>
                        </div>
                        
                        <div class="planificacion-inputs">
                            <div class="input-group">
                                <div class="input-label">PLANIFICADOS</div>
                                <input 
                                    type="number" 
                                    id="hitos_planificados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="hitosPlanificadosError"></div>
                            </div>
                            
                            <div class="input-group">
                                <div class="input-label">REALIZADOS</div>
                                <input 
                                    type="number" 
                                    id="hitos_realizados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="hitosRealizadosError"></div>
                            </div>
                        </div>
                        
                        <div id="hitosValidacion" class="validacion-mensaje"></div>
                    </div>
                    
                    <!-- PASOS NO HABILITADOS -->
                    <div class="planificacion-card" id="cardPNH">
                        <div class="estado-cumplimiento" id="estadoPNH"></div>
                        
                        <div class="planificacion-header">
                            <div class="planificacion-icon">üö´</div>
                            <div class="planificacion-title">PASOS NO HABILITADOS</div>
                            <div class="planificacion-subtitle">Cruces fronterizos no oficiales</div>
                        </div>
                        
                        <div class="planificacion-inputs">
                            <div class="input-group">
                                <div class="input-label">PLANIFICADOS</div>
                                <input 
                                    type="number" 
                                    id="pnh_planificados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="pnhPlanificadosError"></div>
                            </div>
                            
                            <div class="input-group">
                                <div class="input-label">REALIZADOS</div>
                                <input 
                                    type="number" 
                                    id="pnh_realizados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="pnhRealizadosError"></div>
                            </div>
                        </div>
                        
                        <div id="pnhValidacion" class="validacion-mensaje"></div>
                    </div>
                    
                    <!-- SITIOS DE INTER√âS -->
                    <div class="planificacion-card" id="cardSitios">
                        <div class="estado-cumplimiento" id="estadoSitios"></div>
                        
                        <div class="planificacion-header">
                            <div class="planificacion-icon">üëÅÔ∏è</div>
                            <div class="planificacion-title">SITIOS DE INTER√âS</div>
                            <div class="planificacion-subtitle">Puntos de vigilancia estrat√©gica</div>
                        </div>
                        
                        <div class="planificacion-inputs">
                            <div class="input-group">
                                <div class="input-label">PLANIFICADOS</div>
                                <input 
                                    type="number" 
                                    id="sitios_planificados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="sitiosPlanificadosError"></div>
                            </div>
                            
                            <div class="input-group">
                                <div class="input-label">REALIZADOS</div>
                                <input 
                                    type="number" 
                                    id="sitios_realizados"
                                    class="planificacion-input"
                                    min="0"
                                    max="999"
                                    value="0"
                                >
                                <div class="error-message" id="sitiosRealizadosError"></div>
                            </div>
                        </div>
                        
                        <div id="sitiosValidacion" class="validacion-mensaje"></div>
                    </div>
                </div>
                
                <!-- Resumen General de Cumplimiento -->
                <div class="resumen-general" id="resumenCumplimiento">
                    <div class="resumen-icono" id="resumenIcono">üìä</div>
                    <div class="resumen-titulo" id="resumenTitulo">CUMPLIMIENTO GENERAL</div>
                    <div class="resumen-valor" id="resumenPorcentaje">0%</div>
                    <div class="resumen-descripcion" id="resumenDescripcion">
                        <span id="resumenRealizados">0</span> de <span id="resumenPlanificados">0</span> actividades realizadas
                    </div>
                </div>
                
                <!-- Observaciones -->
                <div class="form-group" style="margin-top: var(--spacing-xl);">
                    <label for="observaciones" class="form-label">
                        üìù OBSERVACIONES
                    </label>
                    <textarea 
                        id="observaciones" 
                        class="form-control"
                        rows="4"
                        placeholder="Ingrese observaciones relevantes sobre la demanda preventiva: dificultades encontradas, condiciones del terreno, coordinaci√≥n con otras unidades, etc."
                        maxlength="1000"
                    ></textarea>
                    <div class="observaciones-counter" id="observacionesCounter">
                        <span id="observacionesCaracteres">0</span> / 1000 caracteres
                    </div>
                    <div class="error-message" id="observacionesError"></div>
                </div>
            </div>
            
            <!-- Botones de Navegaci√≥n -->
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-outline" onclick="window.location.href='demanda-ciudadana.html'">
                    ‚Üê VOLVER AL PASO 2
                </button>
                
                <div style="display: flex; gap: var(--spacing-md);">
                    <button type="button" class="btn btn-outline" onclick="window.location.href='../index.html'">
                        üö™ Salir
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnContinuar">
                        VER RESUMEN COMPLETO ‚Üí
                    </button>
                </div>
            </div>
        </form>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script>
        // Variables globales
        let userData = {};
        let servicioId = null;
        let servicioInfo = {};
        let datosPaso2 = {};
        let modoOffline = false;
        
        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(texto, tipo = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = texto;
            messageEl.className = `alert alert-${tipo}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // Funci√≥n para mostrar error en campo
        function mostrarErrorCampo(campoId, mensaje) {
            const campo = document.getElementById(campoId);
            const errorEl = document.getElementById(campoId + 'Error');
            
            if (errorEl) {
                errorEl.textContent = mensaje;
                campo.classList.add('error');
                errorEl.style.display = 'block';
            }
        }
        
        // Funci√≥n para limpiar errores
        function limpiarErrores() {
            document.querySelectorAll('.error').forEach(el => {
                el.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }
        
        // Funci√≥n para actualizar loading
        function actualizarLoading(mensaje, detalles = '', paso = 1, estado = 'processing') {
            document.getElementById('loadingMessage').textContent = mensaje;
            document.getElementById('loadingDetails').textContent = detalles;
            
            const stepEl = document.getElementById(`step${paso}Status`);
            if (stepEl) {
                stepEl.textContent = detalles;
                stepEl.className = `step-status step-${estado}`;
            }
        }
        
        // Funci√≥n para calcular cumplimiento
        function calcularCumplimiento() {
            let totalPlanificados = 0;
            let totalRealizados = 0;
            let totalCompletas = 0;
            
            // HITOS
            const hitosPlan = parseInt(document.getElementById('hitos_planificados').value) || 0;
            const hitosReal = parseInt(document.getElementById('hitos_realizados').value) || 0;
            const cardHitos = document.getElementById('cardHitos');
            const estadoHitos = document.getElementById('estadoHitos');
            const hitosValidacion = document.getElementById('hitosValidacion');
            
            totalPlanificados += hitosPlan;
            totalRealizados += hitosReal;
            
            if (hitosPlan > 0) {
                if (hitosReal > hitosPlan) {
                    // ERROR: Realizados > Planificados
                    mostrarErrorCampo('hitos_realizados', `No puede realizar m√°s (${hitosReal}) de lo planificado (${hitosPlan})`);
                    hitosValidacion.className = 'validacion-mensaje validacion-incorrecta';
                    hitosValidacion.textContent = `‚ùå ERROR: Excede lo planificado`;
                    cardHitos.className = 'planificacion-card sin-realizar';
                    estadoHitos.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (hitosReal === 0) {
                    // ADVERTENCIA: Planificado pero no realizado
                    hitosValidacion.className = 'validacion-mensaje validacion-advertencia';
                    hitosValidacion.textContent = `‚ö†Ô∏è Planific√≥ visitas pero no realiz√≥ ninguna`;
                    cardHitos.className = 'planificacion-card sin-realizar';
                    estadoHitos.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (hitosReal === hitosPlan) {
                    // COMPLETO: Realizado = Planificado
                    const porcentaje = 100;
                    hitosValidacion.className = 'validacion-mensaje validacion-correcta';
                    hitosValidacion.textContent = `‚úÖ Cumplimiento: ${porcentaje}%`;
                    cardHitos.className = 'planificacion-card completa';
                    estadoHitos.className = 'estado-cumplimiento estado-completa';
                    totalCompletas++;
                } else {
                    // PARCIAL: Realizado < Planificado
                    const porcentaje = Math.round((hitosReal / hitosPlan) * 100);
                    hitosValidacion.className = 'validacion-mensaje validacion-info';
                    hitosValidacion.textContent = `üìä Cumplimiento: ${porcentaje}%`;
                    cardHitos.className = 'planificacion-card parcial';
                    estadoHitos.className = 'estado-cumplimiento estado-parcial';
                }
            } else {
                // Sin planificaci√≥n
                hitosValidacion.className = 'validacion-mensaje validacion-info';
                hitosValidacion.textContent = `‚ÑπÔ∏è No se planificaron visitas`;
                cardHitos.className = 'planificacion-card';
                estadoHitos.className = 'estado-cumplimiento';
            }
            
            // PNH
            const pnhPlan = parseInt(document.getElementById('pnh_planificados').value) || 0;
            const pnhReal = parseInt(document.getElementById('pnh_realizados').value) || 0;
            const cardPNH = document.getElementById('cardPNH');
            const estadoPNH = document.getElementById('estadoPNH');
            const pnhValidacion = document.getElementById('pnhValidacion');
            
            totalPlanificados += pnhPlan;
            totalRealizados += pnhReal;
            
            if (pnhPlan > 0) {
                if (pnhReal > pnhPlan) {
                    mostrarErrorCampo('pnh_realizados', `No puede realizar m√°s (${pnhReal}) de lo planificado (${pnhPlan})`);
                    pnhValidacion.className = 'validacion-mensaje validacion-incorrecta';
                    pnhValidacion.textContent = `‚ùå ERROR: Excede lo planificado`;
                    cardPNH.className = 'planificacion-card sin-realizar';
                    estadoPNH.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (pnhReal === 0) {
                    pnhValidacion.className = 'validacion-mensaje validacion-advertencia';
                    pnhValidacion.textContent = `‚ö†Ô∏è Planific√≥ visitas pero no realiz√≥ ninguna`;
                    cardPNH.className = 'planificacion-card sin-realizar';
                    estadoPNH.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (pnhReal === pnhPlan) {
                    const porcentaje = 100;
                    pnhValidacion.className = 'validacion-mensaje validacion-correcta';
                    pnhValidacion.textContent = `‚úÖ Cumplimiento: ${porcentaje}%`;
                    cardPNH.className = 'planificacion-card completa';
                    estadoPNH.className = 'estado-cumplimiento estado-completa';
                    totalCompletas++;
                } else {
                    const porcentaje = Math.round((pnhReal / pnhPlan) * 100);
                    pnhValidacion.className = 'validacion-mensaje validacion-info';
                    pnhValidacion.textContent = `üìä Cumplimiento: ${porcentaje}%`;
                    cardPNH.className = 'planificacion-card parcial';
                    estadoPNH.className = 'estado-cumplimiento estado-parcial';
                }
            } else {
                pnhValidacion.className = 'validacion-mensaje validacion-info';
                pnhValidacion.textContent = `‚ÑπÔ∏è No se planificaron visitas`;
                cardPNH.className = 'planificacion-card';
                estadoPNH.className = 'estado-cumplimiento';
            }
            
            // SITIOS
            const sitiosPlan = parseInt(document.getElementById('sitios_planificados').value) || 0;
            const sitiosReal = parseInt(document.getElementById('sitios_realizados').value) || 0;
            const cardSitios = document.getElementById('cardSitios');
            const estadoSitios = document.getElementById('estadoSitios');
            const sitiosValidacion = document.getElementById('sitiosValidacion');
            
            totalPlanificados += sitiosPlan;
            totalRealizados += sitiosReal;
            
            if (sitiosPlan > 0) {
                if (sitiosReal > sitiosPlan) {
                    mostrarErrorCampo('sitios_realizados', `No puede realizar m√°s (${sitiosReal}) de lo planificado (${sitiosPlan})`);
                    sitiosValidacion.className = 'validacion-mensaje validacion-incorrecta';
                    sitiosValidacion.textContent = `‚ùå ERROR: Excede lo planificado`;
                    cardSitios.className = 'planificacion-card sin-realizar';
                    estadoSitios.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (sitiosReal === 0) {
                    sitiosValidacion.className = 'validacion-mensaje validacion-advertencia';
                    sitiosValidacion.textContent = `‚ö†Ô∏è Planific√≥ visitas pero no realiz√≥ ninguna`;
                    cardSitios.className = 'planificacion-card sin-realizar';
                    estadoSitios.className = 'estado-cumplimiento estado-sin-realizar';
                } else if (sitiosReal === sitiosPlan) {
                    const porcentaje = 100;
                    sitiosValidacion.className = 'validacion-mensaje validacion-correcta';
                    sitiosValidacion.textContent = `‚úÖ Cumplimiento: ${porcentaje}%`;
                    cardSitios.className = 'planificacion-card completa';
                    estadoSitios.className = 'estado-cumplimiento estado-completa';
                    totalCompletas++;
                } else {
                    const porcentaje = Math.round((sitiosReal / sitiosPlan) * 100);
                    sitiosValidacion.className = 'validacion-mensaje validacion-info';
                    sitiosValidacion.textContent = `üìä Cumplimiento: ${porcentaje}%`;
                    cardSitios.className = 'planificacion-card parcial';
                    estadoSitios.className = 'estado-cumplimiento estado-parcial';
                }
            } else {
                sitiosValidacion.className = 'validacion-mensaje validacion-info';
                sitiosValidacion.textContent = `‚ÑπÔ∏è No se planificaron visitas`;
                cardSitios.className = 'planificacion-card';
                estadoSitios.className = 'estado-cumplimiento';
            }
            
            // Calcular resumen general
            const resumenCumplimiento = document.getElementById('resumenCumplimiento');
            
            if (totalPlanificados > 0) {
                const porcentajeGeneral = Math.round((totalRealizados / totalPlanificados) * 100);
                const actividadesCompletas = totalCompletas;
                
                document.getElementById('resumenRealizados').textContent = totalRealizados;
                document.getElementById('resumenPlanificados').textContent = totalPlanificados;
                document.getElementById('resumenPorcentaje').textContent = `${porcentajeGeneral}%`;
                
                // Determinar icono y t√≠tulo seg√∫n porcentaje
                let icono = 'üìä';
                let titulo = 'CUMPLIMIENTO GENERAL';
                
                if (porcentajeGeneral >= 80) {
                    icono = '‚úÖ';
                    titulo = 'EXCELENTE CUMPLIMIENTO';
                } else if (porcentajeGeneral >= 50) {
                    icono = '‚ö†Ô∏è';
                    titulo = 'CUMPLIMIENTO REGULAR';
                } else if (porcentajeGeneral > 0) {
                    icono = 'üìâ';
                    titulo = 'CUMPLIMIENTO BAJO';
                } else {
                    icono = 'üö´';
                    titulo = 'SIN ACTIVIDADES REALIZADAS';
                }
                
                document.getElementById('resumenIcono').textContent = icono;
                document.getElementById('resumenTitulo').textContent = titulo;
                resumenCumplimiento.style.display = 'block';
                
            } else {
                resumenCumplimiento.style.display = 'none';
            }
            
            return {
                totalPlanificados,
                totalRealizados,
                tieneErrores: document.querySelectorAll('.validacion-incorrecta').length > 0
            };
        }
        
        // Funci√≥n para contar caracteres de observaciones
        function contarCaracteresObservaciones() {
            const textarea = document.getElementById('observaciones');
            const counter = document.getElementById('observacionesCounter');
            const caracteres = document.getElementById('observacionesCaracteres');
            
            const longitud = textarea.value.length;
            caracteres.textContent = longitud;
            
            counter.className = 'observaciones-counter';
            
            if (longitud > 900) {
                counter.classList.add('warning');
            }
            
            if (longitud > 990) {
                counter.classList.add('error');
            }
        }
        
        // Funci√≥n para validar formulario
        function validarFormulario() {
            let esValido = true;
            limpiarErrores();
            
            // Calcular cumplimiento (esto tambi√©n valida)
            const { tieneErrores } = calcularCumplimiento();
            
            if (tieneErrores) {
                esValido = false;
                mostrarMensaje('‚ùå Corrija los errores en los campos de planificaci√≥n', 'danger');
            }
            
            // Validar n√∫meros positivos
            const camposNumericos = [
                'hitos_planificados', 'hitos_realizados',
                'pnh_planificados', 'pnh_realizados',
                'sitios_planificados', 'sitios_realizados'
            ];
            
            camposNumericos.forEach(campoId => {
                const valor = parseInt(document.getElementById(campoId).value) || 0;
                if (valor < 0) {
                    mostrarErrorCampo(campoId, 'El valor no puede ser negativo');
                    esValido = false;
                }
                if (valor > 999) {
                    mostrarErrorCampo(campoId, 'El valor no puede exceder 999');
                    esValido = false;
                }
            });
            
            // Validar observaciones (opcional, pero si hay texto, validar longitud)
            const observaciones = document.getElementById('observaciones').value;
            if (observaciones.length > 1000) {
                mostrarErrorCampo('observaciones', 'Las observaciones no pueden exceder los 1000 caracteres');
                esValido = false;
            }
            
            return esValido;
        }
        
        // Funci√≥n para cargar informaci√≥n del servicio
        async function cargarInformacionServicio() {
            try {
                // Obtener datos del paso 1 desde localStorage
                const paso1Data = localStorage.getItem('servicio_paso1');
                if (!paso1Data) {
                    throw new Error('No se encontraron datos del paso 1');
                }
                
                servicioInfo = JSON.parse(paso1Data);
                servicioId = localStorage.getItem('servicio_id');
                
                if (!servicioId) {
                    throw new Error('No se encontr√≥ ID del servicio');
                }
                
                // Obtener datos del paso 2
                const paso2Data = localStorage.getItem('servicio_paso2');
                if (!paso2Data) {
                    throw new Error('No se encontraron datos del paso 2');
                }
                
                datosPaso2 = JSON.parse(paso2Data);
                
                // Verificar modo offline
                modoOffline = localStorage.getItem('servicio_offline') === 'true';
                
                console.log('üìã Informaci√≥n del servicio cargada:', {
                    servicioInfo,
                    datosPaso2,
                    modoOffline
                });
                
                // Mostrar informaci√≥n en la p√°gina
                document.getElementById('infoFecha').textContent = servicioInfo.fecha;
                document.getElementById('infoCuartel').textContent = servicioInfo.cuartel_codigo;
                document.getElementById('infoServicio').textContent = servicioInfo.nombre_servicio;
                
                // Calcular totales del paso 2
                const totalControles = 
                    (datosPaso2.controles_investigativos || 0) +
                    (datosPaso2.controles_preventivos || 0) +
                    (datosPaso2.controles_migratorios || 0) +
                    (datosPaso2.controles_vehiculares || 0);
                
                const totalInfracciones = 
                    (datosPaso2.infracciones_transito || 0) +
                    (datosPaso2.otras_infracciones || 0);
                
                document.getElementById('infoControles').textContent = totalControles;
                document.getElementById('infoInfracciones').textContent = totalInfracciones;
                document.getElementById('infoDetenidos').textContent = datosPaso2.detenidos_cantidad || 0;
                
                // Verificar si el servicio existe en Supabase (solo si no est√° en modo offline)
                if (!modoOffline) {
                    actualizarLoading('Verificando servicio...', 'Buscando en base de datos', 1, 'processing');
                    
                    const { data: servicioExistente, error } = await SICOF_CONFIG.supabase
                        .from('servicios')
                        .select('id, cuartel_codigo, nombre_servicio')
                        .eq('id', servicioId)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') { // No encontrado
                            console.warn('‚ö†Ô∏è Servicio no encontrado en Supabase, activando modo offline');
                            modoOffline = true;
                            localStorage.setItem('servicio_offline', 'true');
                            mostrarMensaje('‚ö†Ô∏è Modo offline: Los datos se guardar√°n localmente', 'warning');
                        } else {
                            throw error;
                        }
                    } else {
                        console.log('‚úÖ Servicio verificado en Supabase:', servicioExistente);
                        actualizarLoading('Servicio verificado', 'Listo para continuar', 1, 'success');
                    }
                } else {
                    console.log('üåê Modo offline activado');
                    mostrarMensaje('‚ö†Ô∏è Modo offline: Los datos se guardar√°n localmente', 'warning');
                }
                
                // Cargar datos guardados del paso 3 si existen
                const paso3Data = localStorage.getItem('servicio_paso3');
                if (paso3Data) {
                    const datosPaso3 = JSON.parse(paso3Data);
                    console.log('üìÇ Datos del paso 3 cargados:', datosPaso3);
                    
                    // Llenar campos con datos existentes
                    Object.keys(datosPaso3).forEach(key => {
                        const elemento = document.getElementById(key);
                        if (elemento) {
                            if (elemento.type === 'number') {
                                elemento.value = datosPaso3[key] || 0;
                            } else if (elemento.tagName === 'TEXTAREA') {
                                elemento.value = datosPaso3[key] || '';
                            }
                        }
                    });
                    
                    // Calcular cumplimiento inicial
                    calcularCumplimiento();
                    contarCaracteresObservaciones();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando informaci√≥n del servicio:', error);
                throw error;
            }
        }
        
        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando demanda-preventiva.html');
            
            try {
                // Verificar autenticaci√≥n
                userData = await protegerPagina('digitador');
                if (!userData) return;
                
                console.log('‚úÖ Usuario autenticado:', userData);
                
                // Mostrar informaci√≥n del usuario
                document.getElementById('userInfo').textContent = `${userData.rol.toUpperCase()} - ${userData.email}`;
                
                // Mostrar cuartel
                const cuartelInfo = await obtenerCuarteles();
                const cuartelUsuario = cuartelInfo.find(c => c.codigo === userData.cuartel_codigo);
                if (cuartelUsuario) {
                    document.getElementById('cuartelNombre').textContent = cuartelUsuario.nombre;
                }
                
                // Cargar informaci√≥n del servicio
                await cargarInformacionServicio();
                
                // Configurar eventos
                configurarEventos();
                
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                
                if (error.message.includes('paso 1') || error.message.includes('paso 2')) {
                    mostrarMensaje('‚ùå Complete primero los pasos anteriores', 'danger');
                    setTimeout(() => window.location.href = 'datos-servicio.html', 2000);
                } else {
                    mostrarMensaje(`Error inicializando: ${error.message}`, 'danger');
                }
            }
        });
        
        function configurarEventos() {
            // Calcular cumplimiento en tiempo real
            const camposPlanificacion = [
                'hitos_planificados', 'hitos_realizados',
                'pnh_planificados', 'pnh_realizados',
                'sitios_planificados', 'sitios_realizados'
            ];
            
            camposPlanificacion.forEach(id => {
                document.getElementById(id).addEventListener('input', calcularCumplimiento);
            });
            
            // Contar caracteres de observaciones
            document.getElementById('observaciones').addEventListener('input', contarCaracteresObservaciones);
            
            // Validar n√∫meros
            document.querySelectorAll('.planificacion-input').forEach(input => {
                input.addEventListener('change', function() {
                    const value = parseInt(this.value);
                    if (isNaN(value) || value < 0) {
                        this.value = 0;
                    }
                    if (value > 999) {
                        this.value = 999;
                    }
                });
            });
            
            // Manejar env√≠o del formulario
            document.getElementById('preventivaForm').addEventListener('submit', guardarPaso3);
        }
        
        async function guardarPaso3(e) {
            e.preventDefault();
            
            console.log('üìù Iniciando guardado del paso 3...');
            
            // Validar formulario
            if (!validarFormulario()) {
                mostrarMensaje('‚ùå Por favor corrija los errores en el formulario', 'danger');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            actualizarLoading('Guardando datos de demanda preventiva...', 'Paso 3: Planificaci√≥n y cumplimiento', 1, 'processing');
            
            try {
                // Preparar datos para actualizar
                const formData = {
                    // Planificaci√≥n
                    hitos_planificados: parseInt(document.getElementById('hitos_planificados').value) || 0,
                    hitos_realizados: parseInt(document.getElementById('hitos_realizados').value) || 0,
                    pnh_planificados: parseInt(document.getElementById('pnh_planificados').value) || 0,
                    pnh_realizados: parseInt(document.getElementById('pnh_realizados').value) || 0,
                    sitios_planificados: parseInt(document.getElementById('sitios_planificados').value) || 0,
                    sitios_realizados: parseInt(document.getElementById('sitios_realizados').value) || 0,
                    
                    // Observaciones
                    observaciones: document.getElementById('observaciones').value.trim() || null
                };
                
                console.log('üì¶ Datos preparados para actualizar:', formData);
                
                // Calcular estad√≠sticas
                const { totalPlanificados, totalRealizados } = calcularCumplimiento();
                const porcentajeCumplimiento = totalPlanificados > 0 ? 
                    Math.round((totalRealizados / totalPlanificados) * 100) : 0;
                
                // Verificar si estamos en modo offline
                if (modoOffline) {
                    console.log('üåê Modo offline detectado, guardando localmente');
                    
                    // Guardar datos en localStorage
                    localStorage.setItem('servicio_paso3', JSON.stringify(formData));
                    
                    actualizarLoading('‚úÖ Datos guardados localmente', 'Modo offline activado', 2, 'success');
                    
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        mostrarMensaje(`
                            ‚úÖ <strong>DATOS GUARDADOS LOCALMENTE</strong><br>
                            ‚Ä¢ Cumplimiento: ${porcentajeCumplimiento}%<br>
                            ‚Ä¢ Actividades realizadas: ${totalRealizados}/${totalPlanificados}<br>
                            ‚Ä¢ Modo offline activado<br>
                            ‚Ä¢ Redirigiendo al resumen...
                        `, 'warning');
                        
                        // Redirigir al resumen
                        setTimeout(() => {
                            window.location.href = 'resumen-confirmacion.html';
                        }, 2000);
                    }, 1500);
                    
                    return;
                }
                
                // Actualizar en Supabase
                actualizarLoading('Actualizando en base de datos...', 'Tabla: servicios', 2, 'processing');
                
                const { data, error } = await SICOF_CONFIG.supabase
                    .from('servicios')
                    .update(formData)
                    .eq('id', servicioId);
                
                if (error) {
                    console.error('‚ùå Error actualizando en Supabase:', error);
                    
                    if (error.code === '42501') {
                        throw new Error('Permiso denegado: No tiene permisos para actualizar');
                    } else if (error.code === 'PGRST116') {
                        throw new Error('El servicio no existe en la base de datos');
                    } else {
                        throw new Error(`Error de base de datos: ${error.message}`);
                    }
                }
                
                console.log('‚úÖ Servicio actualizado exitosamente:', data);
                
                // Guardar datos en localStorage tambi√©n
                localStorage.setItem('servicio_paso3', JSON.stringify(formData));
                
                actualizarLoading('‚úÖ Paso 3 completado', 'Datos guardados correctamente', 2, 'success');
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Determinar nivel de cumplimiento
                    let nivelCumplimiento = 'BAJO';
                    let iconoCumplimiento = 'üìâ';
                    
                    if (porcentajeCumplimiento >= 80) {
                        nivelCumplimiento = 'EXCELENTE';
                        iconoCumplimiento = '‚úÖ';
                    } else if (porcentajeCumplimiento >= 50) {
                        nivelCumplimiento = 'REGULAR';
                        iconoCumplimiento = '‚ö†Ô∏è';
                    }
                    
                    mostrarMensaje(`
                        ‚úÖ <strong>PASO 3 COMPLETADO CORRECTAMENTE</strong><br>
                        ${iconoCumplimiento} <strong>Cumplimiento ${nivelCumplimiento}: ${porcentajeCumplimiento}%</strong><br>
                        ‚Ä¢ Actividades realizadas: ${totalRealizados}/${totalPlanificados}<br>
                        ‚Ä¢ Redirigiendo al resumen completo...
                    `, 'success');
                    
                    // Redirigir al resumen despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'resumen-confirmacion.html';
                    }, 2000);
                    
                }, 1500);
                
            } catch (error) {
                console.error('üî• Error guardando paso 3:', error);
                
                actualizarLoading('‚ùå Error al guardar', error.message, 2, 'error');
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Intentar guardar localmente como fallback
                    try {
                        const formData = {
                            hitos_planificados: parseInt(document.getElementById('hitos_planificados').value) || 0,
                            hitos_realizados: parseInt(document.getElementById('hitos_realizados').value) || 0,
                            pnh_planificados: parseInt(document.getElementById('pnh_planificados').value) || 0,
                            pnh_realizados: parseInt(document.getElementById('pnh_realizados').value) || 0,
                            sitios_planificados: parseInt(document.getElementById('sitios_planificados').value) || 0,
                            sitios_realizados: parseInt(document.getElementById('sitios_realizados').value) || 0,
                            observaciones: document.getElementById('observaciones').value.trim() || null
                        };
                        
                        localStorage.setItem('servicio_paso3', JSON.stringify(formData));
                        localStorage.setItem('servicio_offline', 'true');
                        modoOffline = true;
                        
                        const { totalPlanificados, totalRealizados } = calcularCumplimiento();
                        const porcentajeCumplimiento = totalPlanificados > 0 ? 
                            Math.round((totalRealizados / totalPlanificados) * 100) : 0;
                        
                        console.log('üíæ Datos guardados en modo offline');
                        
                        mostrarMensaje(`
                            ‚ö†Ô∏è <strong>MODO OFFLINE ACTIVADO</strong><br>
                            ‚Ä¢ Error de conexi√≥n a la base de datos<br>
                            ‚Ä¢ Los datos se guardaron localmente<br>
                            ‚Ä¢ Cumplimiento: ${porcentajeCumplimiento}%<br>
                            ‚Ä¢ Se sincronizar√°n cuando haya conexi√≥n<br>
                            ‚Ä¢ Redirigiendo al resumen...
                        `, 'warning');
                        
                        setTimeout(() => {
                            window.location.href = 'resumen-confirmacion.html';
                        }, 3000);
                        
                    } catch (localError) {
                        console.error('Error guardando localmente:', localError);
                        mostrarMensaje(`‚ùå Error cr√≠tico: ${error.message}<br>No se pudieron guardar los datos`, 'danger');
                    }
                }, 2000);
            }
        }
        
        // Funci√≥n para debugging
        window.debugInfo = function() {
            console.log('=== DEBUG DEMANDA-PREVENTIVA ===');
            console.log('Usuario:', userData);
            console.log('Servicio ID:', servicioId);
            console.log('Servicio Info:', servicioInfo);
            console.log('Datos Paso 2:', datosPaso2);
            console.log('Modo Offline:', modoOffline);
            console.log('Servicio Paso 3 (localStorage):', localStorage.getItem('servicio_paso3'));
            console.log('SICOF_CONFIG:', SICOF_CONFIG ? 'Presente' : 'Ausente');
            console.log('Supabase inicializado:', SICOF_CONFIG.supabase ? '‚úÖ' : '‚ùå');
            console.log('===============================');
            
            alert('Debug info en consola. Verifica la consola del navegador (F12)');
        };
    </script>
</body>
</html>
