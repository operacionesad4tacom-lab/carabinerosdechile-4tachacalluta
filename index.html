<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const msg = document.getElementById('message');
    const loginBtn = document.getElementById('loginBtn');
    
    // Validaci√≥n b√°sica
    if (!email || !password) {
        mostrarError('Por favor completa todos los campos');
        return;
    }
    
    // Deshabilitar bot√≥n
    loginBtn.disabled = true;
    loginBtn.textContent = '‚è≥ Autenticando...';
    msg.style.display = 'none';
    
    try {
        // SOLO LLAMAMOS A SUPABASE
        const usuario = await window.loginUsuario(email, password);
        
        // Mostrar √©xito
        msg.innerHTML = `
            <strong>‚úÖ Autenticaci√≥n exitosa</strong><br>
            <small>Bienvenido ${usuario.nombre} (${usuario.rol})</small>
        `;
        msg.className = 'alert alert-success';
        msg.style.display = 'block';
        
        // Redirigir seg√∫n el rol que viene de Supabase
        setTimeout(() => {
            const destino = window.SICOF_CONFIG.redirectUrls[usuario.rol] || 'dashboard.html';
            window.location.href = destino;
        }, 1000);
        
    } catch (error) {
        // Mostrar error
        mostrarError(error.message);
        
        // Rehabilitar bot√≥n
        loginBtn.disabled = false;
        loginBtn.textContent = 'üö™ INGRESAR';
    }
});

function mostrarError(mensaje) {
    const msg = document.getElementById('message');
    msg.innerHTML = `<strong>‚ùå ${mensaje}</strong>`;
    msg.className = 'alert alert-danger';
    msg.style.display = 'block';
    
    setTimeout(() => msg.style.display = 'none', 5000);
}

// Funci√≥n para pruebas r√°pidas
function autoLogin(email) {
    document.getElementById('email').value = email;
    document.getElementById('password').value = 'Monta√±aofrontera2026';
    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
}

// Verificar si ya est√° logueado
(async () => {
    try {
        const user = await window.verificarSesion();
        if (user) {
            console.log('Redirigiendo usuario autenticado:', user.rol);
            const destino = window.SICOF_CONFIG.redirectUrls[user.rol] || 'dashboard.html';
            window.location.href = destino;
        }
    } catch (error) {
        console.log('No hay sesi√≥n activa');
    }
})();
</script>
